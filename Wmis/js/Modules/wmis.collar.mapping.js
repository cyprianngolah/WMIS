wmis.collar = wmis.collar || {};
wmis.collar.mapping = (function ($) {
	
    var Markers = (function() {

        function addMarker(map, coordinates, caribouId, message, icon) {
            var marker = new google.maps.Marker({
                position: coordinates,
                title: message,
                icon: icon
            });

            marker.setMap(map);
            google.maps.event.addListener(marker, 'click', showInfoWindow(map, coordinates, caribouId));
        }

        function showInfoWindow(map, coordinates, caribouId) {
            return function () {
                var infoWindow = new google.maps.InfoWindow({
                    content: getInfoMessage(coordinates, caribouId)
                });
                infoWindow.open(map, marker);
            }
        }

        function getLatLongString(coordinates) {
            return coordinates.lat() + ", " + coordinates.lng();
        }

        function getInfoMessage(coordinates, caribouId) {
            return "Caribou Id: " + caribouId + "<br/>" + getLatLongString(coordinates);
        }

        function getHoverMessage(coordinates) {
            return getLatLongString(coordinates);
        }

        return {
            addStartMarker: function(map, coordinates, caribouId) {
                addMarker(map, coordinates, caribouId, "Start: " + getHoverMessage(coordinates), "/content/images/maps-symbol-blank-start.png");
            },

            addStopMarker: function(map, coordinates, caribouId) {
                addMarker(map, coordinates, caribouId, "Stop" + getHoverMessage(coordinates), "/content/images/maps-symbol-blank-stop.png");
            },

            addMiddleMarker: function(map, coordinates, caribouId) {
                addMarker(map, coordinates, caribouId, getHoverMessage(coordinates), null);
            }
        }
    })();

    var Polyline = (function() {

        var caribouIcon = {
            path: "m 181.15625,257.5 c -5.14062,-0.0168 -10.27898,0.5818 -15.28125,1.75 1.4299,0.98164 2.84023,1.93135 3.6875,3.25 -2.41157,3.86734 -8.99646,2.10826 -12.375,0.40625 -0.28507,-0.25439 -0.53329,-0.46339 -0.78125,-0.65625 -0.94351,0.37667 -1.88692,0.76694 -2.8125,1.1875 0.26167,1.34462 0.96389,3.03895 1.84375,4.34375 0.37474,1.01975 3.68051,2.88342 1.75,4.125 -7.88079,3.84958 -12.61261,-9.70766 -19,-3.8125 -3.24694,1.55572 -6.57212,2.86743 -9.96875,3.96875 l 4.15625,3.5625 c 2.95386,1.10772 0.0199,3.60619 -0.65625,5.25 -11.76107,-2.68936 -24.26264,-4.86008 -36.34375,-2.28125 -2.492127,0.86884 -5.369445,2.09866 -5.75,-1.875 l -19.65625,7.125 c 1.992711,2.53623 3.977301,5.05658 5.96875,7.59375 -0.884998,3.29958 -3.197644,6.46753 -4.53125,9.71875 L 81.9375,300.625 c 3.186443,-0.95415 9.125554,1.37923 9.9375,-2.4375 7.292858,-3.53926 16.1711,-3.16144 24.09375,-2.125 1.34302,1.10155 5.7273,-0.5239 6.15625,1.625 -6.77766,2.44868 -14.0215,4.85908 -19.96875,9.28125 -3.038086,0.83288 -5.07921,7.37725 -8.5625,3.625 l -8.0625,11.53125 c -1.222626,2.4711 -6.37282,6.28836 -1,6.46875 3.341833,0.048 4.804139,2.43108 6.8125,4.59375 0.857484,2.41679 0.777713,5.28796 1.34375,7.84375 l 9.5625,-7.4375 c 2.07716,-2.45857 8.0749,-3.81014 5.15625,-7.6875 7.26929,-8.16581 18.73026,-11.3155 29.28125,-12.96875 7.67406,8.39331 18.57367,14.32467 30.15625,14.75 16.6297,-1.96062 30.95293,9.37033 47.25,10.125 3.2425,9.00176 6.50252,18.38368 11.84375,26.53125 0.79275,2.98022 6.44859,5.37606 3.09375,8.6875 l 10.625,9.46875 c 2.63851,2.7164 5.2314,5.32038 5.1875,-0.21875 -0.26248,-3.48645 4.97442,-2.33945 5.625,-5.625 0.25564,-2.95291 3.60472,-2.02718 5.46875,-2.90625 l -7.3125,-12 c -1.90808,-2.05483 -2.63037,-7.68703 -6.1875,-4.8125 -3.65026,-4.33323 -5.86817,-10.05891 -8.09375,-15.3125 0.21885,-1.6693 -3.13706,-4.56794 -1.5625,-5.9375 6.37738,6.23866 13.36978,12.48724 21.5,16.59375 3.33009,1.84552 8.78692,2.03185 6.84375,7.46875 l 19.5,4.46875 c -0.97168,-3.31696 -1.93793,-6.61964 -2.90625,-9.9375 1.90883,-2.57166 5.02328,-4.50901 7.3125,-6.875 l -11.71875,-6.75 c -2.4033,-0.66483 -5.38331,-4.77042 -7.3125,-2.625 -8.99193,-3.65779 -16.62886,-10.74555 -22.96875,-18.09375 1.48726,-3.8681 3.45655,-8.07001 3.09375,-12.46875 0.62341,-3.12446 -1.74909,-6.4772 -1.40625,-9.34375 6.73409,-5.40158 18.14539,-4.06118 20.90625,4.96875 6.98153,4.50758 6.07388,-10.68798 0.71875,-13.09375 -6.47324,-7.8201 -18.18653,-4.98188 -25.03125,0.75 -2.27085,-1.2411 -2.90758,-5.20183 -5.0625,-6.875 -9.06497,-12.7308 -23.03263,-21.39612 -38.40625,-24.125 -5.46397,-1.49631 -11.06567,-2.23164 -16.6875,-2.25 z m -68.875,-112.8125 c -14.518812,0.52457 -27.51956,9.69731 -36.8125,20.4375 -8.687608,9.33154 -15.352559,20.28528 -23.125,30.3125 -5.97078,6.16192 -13.861298,10.35287 -20.65625,15.625 2.690878,0.18295 5.602776,1.12967 8.34375,2.84375 6.560794,4.10272 9.573954,11.10553 6.71875,15.625 -2.857785,4.51841 -11.720886,6.75881 -18.28125,2.65625 -3.946845,-2.46818 -6.165093,-6.67963 -6.6875,-10.625 -0.191539,0.30981 -0.380842,0.61784 -0.5625,0.9375 -2.88431,7.18554 -7.713048,14.556 -6.375,22.59375 2.80058,6.24458 9.552211,10.3592 5.78125,18.03125 0.03513,2.56388 -1.333207,8.62912 2.09375,9.5 2.673646,-2.67843 3.763558,-7.05733 6.625,-9.78125 7.209908,-8.07259 1.580598,8.14798 5.875,11.40625 0.497986,2.53379 3.372545,1.6071 3.40625,-0.53125 0.708737,-5.56624 8.5895,-12.65069 6.3125,-2.84375 -0.227949,2.69885 -0.213265,8.64995 3.40625,8.9375 1.961435,-2.4938 2.499628,-6.22653 4.71875,-8.71875 5.088487,-3.92395 13.606472,3.46251 20.34375,3.1875 21.501879,4.00343 44.76678,3.40213 64.78125,-6.1875 6.38739,-5.89516 11.11921,7.66208 19,3.8125 1.93051,-1.24158 -1.37526,-3.10525 -1.75,-4.125 -2.30866,-3.42366 -3.50884,-9.56788 1.75,-4.875 3.37854,1.70201 9.96343,3.46109 12.375,-0.40625 -1.84338,-2.86895 -6.39179,-3.96549 -7.875,-7.53125 -0.36583,-1.90289 8.66364,0.8835 10.3125,-3.375 -0.16586,-2.37144 -4.1669,-1.51393 -5.3125,-3.25 -6.90229,-3.08589 3.20187,-8.98371 3.53125,-13.96875 1.853,-4.03756 3.21462,-8.25565 4.09375,-12.5625 -5.29998,-2.9224 -7.05823,-9.42588 -14.21875,-14.75 l 5.0625,-25.875 c 1.09608,0.3217 2.61897,0.67284 4.375,1.03125 -2.72031,-5.89774 -6.31503,-11.38333 -10.75,-16.15625 l -7.15625,10.75 0.0312,0.0312 c -0.97861,1.72294 -2.61241,2.58695 -4.25,2.65625 -1.63759,0.0693 -3.26978,-0.55566 -4.65625,-1.59375 -1.38647,-1.03809 -2.55037,-2.48761 -3.15625,-4.1875 -0.60588,-1.69989 -0.6243,-3.69094 0.28125,-5.5625 l 0.0937,-0.15625 0.125,-0.125 10,-9.59375 c -1.98267,-1.5122 -4.05123,-2.94645 -6.1875,-4.25 -2.10397,-0.79107 -4.43842,-1.97675 -6.9375,-3.6875 -6.36798,-2.95186 -13.16113,-4.9361 -20.125,-5.53125 -1.53168,-0.13835 -3.06055,-0.17927 -4.5625,-0.125 z m -32.25,-17.5625 c -1.771698,0.0187 -3.205621,0.80358 -4.21875,2.59375 -6.640786,11.73169 -5.559419,26.37351 -0.75,35.875 0.139845,-0.15218 0.265355,-0.31741 0.40625,-0.46875 7.834307,-9.05439 18.301066,-16.9786 30.09375,-19.5625 -8.138174,-8.11598 -18.964563,-18.50698 -25.53125,-18.4375 z m 64.1875,-58.1875 c -1.88419,0.0482 -3.76834,0.83699 -5.3125,2.53125 l -0.28125,0.3125 0.0312,0.40625 c 0.23267,3.85637 2.27732,6.94866 4.4375,9.8125 1.78278,2.3635 3.63565,4.61263 4.84375,7.03125 2.00228,-2.53382 4.08546,-4.8661 6.15625,-6.875 1.63508,-1.58622 3.27472,-2.97363 4.90625,-4.15625 -0.12428,-0.12641 -0.24676,-0.2507 -0.375,-0.375 -2.14929,-2.17938 -5.34343,-5.31753 -8.875,-7.1875 -1.76578,-0.93498 -3.64706,-1.54824 -5.53125,-1.5 z M 74.375,56.4375 c -1.420128,7.7e-4 -2.985006,0.65881 -4.625,2 L 69.6875,58.5 69.625,58.5625 c -7.996091,8.90273 -7.998815,21.75168 -8.25,32.59375 l 0,0.0312 0,0.0312 c 0.542685,14.33909 2.553524,30.02995 12.15625,41.6875 l 0,0.0312 c 0.147779,0.16706 0.315814,0.30986 0.46875,0.46875 0.522391,-1.25478 1.131919,-2.48518 1.8125,-3.6875 3.545353,-6.26455 12.542092,-0.12666 21.1875,7.65625 0.584129,-0.17508 1.159465,-0.36086 1.71875,-0.5625 l 0,-0.0312 c 1.43271,-0.14243 2.63139,-1.01095 3.59375,-2.0625 0.12908,-0.14104 0.18961,-0.29078 0.3125,-0.4375 l -1.65625,6.78125 c 1.60709,1.54138 3.12706,3.03815 4.59375,4.5 2.45315,-0.53791 4.94486,-0.8378 7.5,-0.875 l 0.15625,-13.21875 c 5.22197,2.90543 10.63814,5.7933 16.21875,8.34375 -0.66287,-3.08117 -0.6673,-6.56873 -0.1875,-10.25 0.9085,-6.97044 3.57768,-14.72202 7.25,-22.21875 -1.01515,-1.6363 -1.75615,-3.3654 -2.09375,-4.875 l -0.0312,-0.125 -0.0625,-0.125 c -1.6726,-3.04884 -2.84158,-8.10944 -4.84375,-12.34375 -1.00109,-2.11716 -2.21585,-4.05466 -3.9375,-5.4375 -1.72165,-1.38284 -3.94932,-2.13268 -6.65625,-1.875 l -0.25,0 -0.21875,0.15625 c -2.01305,1.31135 -3.05171,3.08639 -3.28125,4.96875 -0.22954,1.88236 0.26534,3.80822 0.96875,5.71875 1.40681,3.82105 3.72152,7.72705 4.09375,10.53125 l 0,0.15625 0.0937,0.15625 c 0.96534,2.01029 0.75135,3.38175 0.0625,4.4375 -0.68885,1.05575 -2.02272,1.83568 -3.53125,2.09375 -1.50853,0.25807 -3.13176,-0.0153 -4.34375,-0.78125 -1.21199,-0.76598 -2.04977,-1.97723 -2.125,-4 l -0.0312,-0.15625 -0.0312,-0.15625 c -1.18194,-3.14595 -0.644,-7.93189 -0.78125,-12.40625 -0.0686,-2.23718 -0.32482,-4.41494 -1.21875,-6.3125 -0.89393,-1.89756 -2.46668,-3.48966 -4.90625,-4.3125 l -0.21875,-0.0625 -0.21875,0.0312 c -2.64407,0.27878 -4.661761,1.35517 -6.03125,2.9375 -1.369489,1.58233 -2.093907,3.58344 -2.5,5.71875 -0.812187,4.27063 -0.329932,9.15088 -0.21875,12.59375 l 0.03125,0.1875 0.0625,0.15625 c 1.220833,2.88374 0.04962,7.42485 -2,9.8125 -1.024807,1.19382 -2.152168,1.80875 -3.1875,1.71875 -1.02785,-0.0894 -2.250712,-0.86453 -3.5,-3.125 -0.0091,-0.0165 -0.02215,-0.0147 -0.03125,-0.0312 -4.282673,-12.80004 -2.42885,-26.88093 -3.875,-40.59375 -1.7e-4,-0.0333 2.98e-4,-0.0912 0,-0.125 -0.02594,-2.94742 -0.533448,-7.76995 -2.1875,-11.3125 -0.836517,-1.7916 -2.006881,-3.32967 -3.75,-3.90625 -0.43578,-0.14414 -0.901624,-0.21901 -1.375,-0.21875 z M 147.5,9.75 c -1.4345,0.005 -2.8695,0.12019 -4.28125,0.375 -3.76468,0.67966 -7.35465,2.39763 -9.6875,5.625 l -0.1875,0.28125 0,0.375 c 0.66879,8.23641 7.9338,13.64901 12.375,19.15625 l 0,0.0312 0.0312,0 c 10.87487,12.08413 23.69063,22.47538 32.1875,36.09375 4.30228,9.85528 4.73856,21.77221 0.78125,31.78125 l 0,0.0312 c -0.82065,2.25753 -1.92602,3.41916 -3.03125,3.90625 -1.10523,0.48709 -2.31042,0.36817 -3.53125,-0.25 -2.44167,-1.23634 -4.6605,-4.60293 -4.5,-8.21875 l 0,-0.125 -0.0312,-0.0937 c -0.15682,-0.81048 -0.33219,-1.61668 -0.5,-2.4375 -1.44847,2.51499 -2.96679,5.07413 -4.53125,7.6875 -4.02428,6.72241 -8.08436,13.51142 -10.28125,18.90625 -1.09845,2.69741 -1.7038,5.05006 -1.6875,6.75 0.0163,1.69994 0.49016,2.63876 1.78125,3.25 1.2182,0.57669 2.1862,0.63244 3.15625,0.34375 0.97005,-0.28869 1.94929,-0.95678 2.9375,-1.96875 1.97641,-2.02394 3.89636,-5.344 5.90625,-8.71875 2.00989,-3.37475 4.14249,-6.82706 6.75,-9.21875 2.60751,-2.3917 5.89738,-3.68038 9.6875,-2.375 1.74042,0.59944 2.93816,1.62366 3.46875,2.9375 0.53064,1.31384 0.40532,2.77055 -0.0312,4.25 -0.87314,2.9589 -2.98334,6.25144 -4.96875,9.5625 -1.98541,3.31106 -3.84347,6.62745 -4.25,9.21875 -0.20327,1.29565 -0.061,2.37374 0.46875,3.28125 0.52979,0.90751 1.51985,1.71357 3.28125,2.375 1.3912,0.52222 2.35676,0.50921 3.125,0.21875 0.76824,-0.29046 1.41614,-0.90616 2,-1.875 1.16771,-1.93769 1.91023,-5.16777 2.5625,-8.53125 0.65227,-3.36348 1.23585,-6.82805 2.4375,-9.4375 0.60082,-1.30472 1.35605,-2.45015 2.46875,-3.15625 1.1127,-0.7061 2.55106,-0.88375 4.09375,-0.46875 1.8355,0.49378 3.20924,1.49076 4.0625,2.84375 0.85326,1.35299 1.20785,3.00306 1.28125,4.78125 0.0892,2.16022 -0.25214,4.59411 -0.71875,7.125 6.99317,-6.36981 12.64643,-14.31633 16.625,-22.6875 l 0.0312,-0.0625 0,-0.0625 c 7.74385,-23.54427 2.02424,-51.36075 -15.9375,-68.875 -0.0102,-0.0104 -0.0212,-0.021 -0.0312,-0.0312 C 187.80731,29.06023 173.09218,15.61024 154.4688,10.5625 l -0.0312,0 -0.0312,-0.0312 c -1.72044,-0.39283 -3.56814,-0.66186 -5.46875,-0.75 -0.47515,-0.022 -0.95933,-0.0328 -1.4375,-0.0312 z m 101.875,59.375 c -0.82074,-0.004 -1.65324,0.0297 -2.5,0.125 -1.81947,0.20466 -3.11182,1.58628 -3.71875,3.40625 -0.60693,1.81997 -0.73074,4.13235 -0.59375,6.90625 0.27397,5.54779 1.65596,12.86789 3.3125,20.65625 1.65654,7.78836 3.56574,16.0616 4.875,23.40625 1.30926,7.34465 2.00911,13.78647 1.3125,17.75 -1.0246,5.82651 -5.06512,13.84328 -9.90625,19.65625 -2.42056,2.90649 -5.05766,5.26891 -7.53125,6.59375 -2.47359,1.32484 -4.66098,1.59639 -6.59375,0.625 -0.43009,-0.21605 -0.70559,-0.51295 -0.90625,-1.21875 -0.20066,-0.7058 -0.25468,-1.80356 -0.0625,-3.25 0.38436,-2.89288 1.7272,-7.21648 4.15625,-13.09375 2.63416,-6.37386 2.06331,-14.15477 0,-20.375 -1.03166,-3.11012 -2.43744,-5.82269 -4.09375,-7.8125 -1.65631,-1.98981 -3.62663,-3.31026 -5.78125,-3.21875 -1.08638,0.0461 -2.05919,0.35496 -2.78125,0.9375 -0.72206,0.58254 -1.15944,1.39188 -1.4375,2.28125 -0.55611,1.77874 -0.50879,3.96364 -0.375,6.4375 0.26758,4.94771 0.91192,11.03512 -0.9375,16.3125 -2.38284,6.8043 -4.8471,11.37375 -7.25,13.65625 -1.20145,1.14125 -2.33163,1.70609 -3.46875,1.84375 -1.13712,0.13766 -2.34274,-0.15449 -3.6875,-0.96875 -2.88577,-1.74681 -3.89468,-4.58714 -4,-8.28125 -0.10532,-3.69411 0.80229,-8.10209 1.71875,-12.4375 0.91646,-4.33541 1.86561,-8.56862 1.71875,-12.125 -0.0734,-1.77819 -0.42799,-3.42826 -1.28125,-4.78125 -0.85326,-1.35299 -2.227,-2.34997 -4.0625,-2.84375 -1.54269,-0.415 -2.98105,-0.23735 -4.09375,0.46875 -1.1127,0.7061 -1.86793,1.85153 -2.46875,3.15625 -1.20165,2.60945 -1.78523,6.07402 -2.4375,9.4375 -0.65227,3.36348 -1.39479,6.59356 -2.5625,8.53125 -0.58386,0.96884 -1.23176,1.58454 -2,1.875 -0.76824,0.29046 -1.7338,0.30347 -3.125,-0.21875 -1.7614,-0.66143 -2.75146,-1.46749 -3.28125,-2.375 -0.52979,-0.90751 -0.67202,-1.9856 -0.46875,-3.28125 0.40653,-2.5913 2.26459,-5.90769 4.25,-9.21875 1.98541,-3.31106 4.09561,-6.6036 4.96875,-9.5625 0.43657,-1.47945 0.56189,-2.93616 0.0312,-4.25 -0.53059,-1.31384 -1.72833,-2.33806 -3.46875,-2.9375 -3.79012,-1.30538 -7.07999,-0.0167 -9.6875,2.375 -2.60751,2.39169 -4.74011,5.844 -6.75,9.21875 -2.00989,3.37475 -3.92984,6.69481 -5.90625,8.71875 -0.98821,1.01197 -1.96745,1.68006 -2.9375,1.96875 -0.97005,0.28869 -1.93805,0.23294 -3.15625,-0.34375 -1.29109,-0.61124 -1.76498,-1.55006 -1.78125,-3.25 -0.0163,-1.69994 0.58905,-4.05259 1.6875,-6.75 2.19689,-5.39483 6.25697,-12.18384 10.28125,-18.90625 4.02428,-6.72241 8.02169,-13.36858 10.15625,-18.65625 1.06728,-2.64384 1.70108,-4.94329 1.53125,-6.90625 -0.0849,-0.98148 -0.38668,-1.89933 -1,-2.625 -0.61332,-0.72567 -1.50565,-1.23065 -2.5625,-1.46875 -5.06858,-1.14172 -10.89738,2.2873 -16.625,7.84375 -5.72762,5.55645 -11.38687,13.43147 -15.90625,21.90625 -4.51938,8.47478 -7.89629,17.51134 -8.9375,25.5 -1.04121,7.98866 0.26624,15.06007 5.40625,19.0625 8.18894,6.37629 14.46848,7.31439 18.75,6.46875 l -13.3125,12.78125 -0.125,0.125 -0.0937,0.15625 c -0.90555,1.87156 -0.88713,3.86261 -0.28125,5.5625 0.60588,1.69989 1.76978,3.14941 3.15625,4.1875 1.38647,1.03809 3.01866,1.66309 4.65625,1.59375 1.63759,-0.0693 3.27139,-0.93331 4.25,-2.65625 l -0.0312,-0.0312 12.46875,-18.78125 c 1.65797,3.10117 8.80683,16.05394 18.28125,26.625 15.45076,3.0411 34.04528,7.70679 31.03125,16.28125 -0.32076,0.91267 -0.69598,1.79511 -1.09375,2.65625 3.71303,0.90688 7.48199,1.38183 11.28125,1.46875 12.43112,0.28439 25.19717,-3.60876 37.65625,-10.4375 3.97421,-2.17837 11.84174,-9.31499 18.375,-20.15625 6.53326,-10.84126 11.57074,-25.37335 9.25,-41.96875 -1.323,-9.46379 -5.07268,-25.84755 -11.8125,-39.625 -3.36991,-6.88872 -7.47374,-13.11599 -12.46875,-17.5 -4.37063,-3.83601 -9.47357,-6.2217 -15.21875,-6.25 z M 17.679297,218.28088 c -2.928197,-1.13933 -12.232721,12.2986 -1.855024,17.51164 4.845377,2.43581 8.015863,-3.21318 8.015863,-3.21318 0,0 -1.501769,6.44356 3.526967,12.3517 4.490576,5.27173 10.937394,6.44526 15.478373,6.90158 6.637106,0.66732 15.63284,-3.34735 12.189436,-10.1321 m -8.284929,-12.1776 c 2.855204,-4.51947 -0.150372,-11.51735 -6.711166,-15.62007 -6.560364,-4.10255 -14.202992,-3.76569 -17.060347,0.7529 -2.857277,4.51962 -1.060372,13.42954 5.499992,17.53209 6.560364,4.10256 15.413736,1.85349 18.271521,-2.66492 z M 165.14091,181.18913 c 10.12532,2.9718 52.71256,7.11276 48.26717,19.75923 -5.18335,14.74852 -20.85529,22.82473 -33.00581,22.3928 -10.81221,-0.38463 -10.9588,-9.34687 -20.30046,-16.29275 M 46.730351,189.75201 c 2.97e-4,-0.006 6.535319,-7.03715 10.794809,-3.62815 3.150082,2.52101 1.138579,8.80515 1.138579,8.80515 m 34.106142,22.56076 c 0,0 5.39886,-7.4399 9.964439,-4.99493 5.65603,3.02866 3.39263,10.75911 3.39263,10.75911",
            anchor: new google.maps.Point(100, 200),
            strokeWeight: 1,
            fillColor: 'brown',
            fillOpacity: .8,
            scale: .15,
            strokeColor: 'black',
        }

        function polyOptionsForPath(path) {
            return {
                path: path,
                strokeColor: '#ff0000',
                strokeOpacity: 1.0,
                strokeWeight: 1,
                icons: [
                    {
                        icon: caribouIcon,
                        offset: '100%',
                        fixedRotation: true
                    }
                ],
            };
        }

        function addMarkers(map, coordinates, caribouId) {
            var start = coordinates[0];
            Markers.addStartMarker(map, start, caribouId);
            
            var middlePoints = coordinates.slice(1, -1);
            _.forEach(middlePoints, function(point) {
                Markers.addMiddleMarker(map, point, caribouId);
            });

            var stop = coordinates[coordinates.length - 1];
            stop && Markers.addStopMarker(map, stop, caribouId);
        }

        function addPolyline(map, coordinates) {
            var pathCoordinates = new google.maps.MVCArray(coordinates);
            var polylineOptions = polyOptionsForPath(pathCoordinates);
            var polyline = new google.maps.Polyline(polylineOptions);

            polyline.setMap(map);
            return polyline;
        }

        function addPolylineAnimation(polyline) {
            var count = 0;
            return window.setInterval(function() {
                count = (count + 1) % 200;

                var icons = polyline.get('icons');
                icons[0].offset = (count / 2) + '%';
                polyline.set('icons', icons);
            }, 50);
        }
        
        function loadPolyline(map, coordinates, caribouId) {
            addMarkers(map, coordinates, caribouId);
            var polyline = addPolyline(map, coordinates);
            var timerId = addPolylineAnimation(polyline);
            return {
                removePolyline: function() {
                    clearInterval(timerId);
                    polyline.setMap(null);
                }
            };
        }

        return {
            loadPolyline: loadPolyline
        };

    })();

	function initializeMap(collarId, mapDiv, passesObservable) {
		var mapOptions = {
                zoom: 6,
                center: new google.maps.LatLng(64.91826, -103.93033)
            };

		var map = new google.maps.Map(document.getElementById(mapDiv), mapOptions);
		var existingPolyline = null;
	    ko.computed(function() {
	        existingPolyline && existingPolyline.removePolyline();
	        var passes = passesObservable();
	        if (passes && passes.length > 0) {
	            var coordinates = _.map(passes, function (pass) {
	                return new google.maps.LatLng(pass.latitude, pass.longitude);
	            });
	            existingPolyline = Polyline.loadPolyline(map, coordinates, collarId);
            }
	    });
	}
	
	return {
	    initializeMap: initializeMap
	};
}(jQuery));